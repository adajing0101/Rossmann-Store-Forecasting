---
title: "Final Project"
author: "Jessica Bao"
date: "3/15/2021"
output: pdf_document
---

```{r echo = T, results = 'hide', error = FALSE, warning = FALSE, message = FALSE}
# Load libraries and prepare data
library("dplyr") 
library("anytime")
library("lubridate")
library("readxl")
library("tidyverse")
library("TSA")
library("fpp")
library("Metrics")
library("corrplot")
library("tidymodels")

train <- read.csv("rossmann-store-sales/train.csv")
store_8 <- train %>% filter(Store==8) %>% arrange(Date)
#store_8

# Convert Date column to type "Date", get the first day of our data
store_8$Date = as.Date(store_8$Date, format = "%Y-%m-%d")

# Convert "03-01" to day of the year 
dayOfYear = as.numeric(format(store_8[1,3], "%j"))

#keep the date information for future use  
store_8$Date <- anydate(store_8$Date)
store_8$year <- year(store_8$Date)
store_8$month <- month(store_8$Date)
store_8$week <- week(store_8$Date)
store_8$day <- day(store_8$Date)

# double check 365 dates each year without missing 
store_8 %>% count(year,sort = TRUE)

#take a look at the data: no missing data 
#summary(store_8)
 
#drop store number 
store_8 <- subset(store_8, select=-1)

# adjust the col sequence 
store_8 <- subset(store_8,select= c(2:ncol(store_8),1))

#factor state holiday
store_8$StateHoliday<-factor(store_8$StateHoliday)
store_8$SchoolHoliday<-factor(store_8$SchoolHoliday)
store_8$DayOfWeek<-factor(store_8$DayOfWeek)
store_8$Open<-factor(store_8$Open)
store_8$Promo<-factor(store_8$Promo)

#convert to time series data
store_8 <- ts(store_8, frequency = 7)
#autoplot(store_8)

#split train test data
train <- window(store_8, start = c(1, 1), end = c(132, 4))
test <-window(store_8, start = c(132, 5))

#autoplot(train)
#autoplot(train[,2])
```

```{r}
# Create a correlation matrix
train_corr <- cor(train)
round(train_corr, 2)[, 2] # Look at the correlations to Sales only

# Sales is weakly correlated with date, StateHoliday, SchoolHoliday, year, Month, Week, and Day.
# Keep: Open, Promo, and DayofWeek.
```


```{r}
# Create the dependent and independent variables.
sales <- train[, "Sales"]
predictors <- train[, c("Open", "Promo", "DayOfWeek")]
```

```{r}
# Differencing
sales_diff1 <- diff(sales, differences = 1)
tsdisplay(sales_diff1, main = "First Difference")
```

```{r}
# ADF test
kpss.test(sales) #p = .01
kpss.test(sales_diff1) #p = .1
```
The null hypothesis of the KPSS test is that the data is stationary. Because the p-value of the KPSS test of the first difference is less than alpha of .05, we reject the null, meaning the data is not stationary.

The p-value of the KPSS test of the second difference is greater than alpha of .05, so we fail to reject the null, meaning the data is stationary.

```{r}
open <- diff(predictors[, "Open"], differences = 1)
promo <- diff(predictors[, "Promo"], differences = 1)
dayofweek <- diff(predictors[, "DayOfWeek"], differences = 1)

kpss.test(open) #p = .1
kpss.test(promo) #p = .1
kpss.test(dayofweek) #p = .08411

predictors_diff1 = cbind(open, promo, dayofweek)
```

```{r}
par(mfrow = c(2, 2))
plot(sales_diff1 ~ predictors_diff1[, "open"])
plot(sales_diff1 ~ predictors_diff1[, "promo"])
plot(sales_diff1 ~ predictors_diff1[, "dayofweek"])
```

```{r}
# Fit a TSLM model.
tslm_fit <- tslm(sales_diff1 ~ predictors_diff1, lambda = "auto")

# Look at the summary of the model.
summary(tslm_fit)

# Look at the residuals.
checkresiduals(tslm_fit)
```

```{r}
# Look at AIC
#glance(tslm_fit)
AIC(tslm_fit, k = 3) # default k is 2 but because we want AICc, adding extra penalty parameter
```

```{r}
# TSLM Box Ljung
Box.test(tslm_fit$residuals, type = c("Ljung-Box"))
```

```{r}
# Fit regression with ARIMA errors
linear_arima_fit <- auto.arima(sales, xreg = predictors, lambda = "auto", seasonal = TRUE, allowdrift = TRUE)

# Look at the summary of the model.
summary(linear_arima_fit)

# Look at the residuals.
checkresiduals(linear_arima_fit)
```

```{r}
# Check EACF of sales
eacf(sales)
```

Try the following:

```{r}
eacf1 <- Arima(sales, xreg = predictors, order = c(3, 1, 2), seasonal=list(order=c(0,0,2), period = 7), lambda = "auto")
summary(eacf1)
checkresiduals(eacf1)
acf(eacf1$residuals)
```

```{r}
# Split the test data into dependent and independent variables.
sales_test <- test[, "Sales"]
predictors_test <- test[, c("Open", "Promo", "DayOfWeek")]

# For TSLM because we're taking the differences, add the last train data
last_train <- train[921, 4]
last_predictors <- tail(predictors,1)

# Append to the test data
sales_test_for_tslm <- ts(c(last_train, sales_test), start = c(132, 4), frequency = frequency(sales_test))
predictors_test_for_tslm <- ts(rbind(last_predictors, predictors_test), start = c(132, 4), frequency = frequency(sales_test))

# Take differences
sales_test_diff1 <- diff(sales_test_for_tslm, differences = 1)
open_test <- diff(predictors_test_for_tslm[, "Open"], differences = 1)
promo_test <- diff(predictors_test_for_tslm[, "Promo"], differences = 1)
dayofweek_test <- diff(predictors_test_for_tslm[, "DayOfWeek"], differences = 1)

predictors_test_diff1 = cbind(open_test, promo_test, dayofweek_test)
colnames(predictors_test_diff1) <- c("open", "promo", "dayofweek")
```

```{r}
# Forecast the next three weeks
pred_tslm <- forecast(tslm_fit, h = 21, predictors_test_diff1, level = c(80, 95))
pred_lm <- forecast(linear_arima_fit, h = 21, xreg = predictors_test, level= c(80, 95))

# Because the TSLM model used differenced data, its forecasts are also the differences between observations. As such, to obtain the actual forecasts, we cumulatively add the difference-forecasts back to the last cumulative observation.

# Take the last data point of the training data
pred_tslm_concat <- c(last_train, pred_tslm$mean)

# Add the TSLM predictions to the last observation and remove the first observation
pred_tslm_act <- cumsum(pred_tslm_concat)
pred_tslm_act <- head(pred_tslm_act, -1)
```

```{r}
#ARIMA with linear error actuals + forecast
autoplot(pred_lm$mean, series = "Predicted", ylab = "Sales") + autolayer(sales_test, series = "Actuals") + autolayer(tail(sales, 13), series = "Last quarter of training data") + xlab("Time") +  ggtitle("sARIMA(1,1,2)(0,0,2)[7] Predicted vs Actual") + autolayer(pred_lm$upper[, 1], lty = 3, series = "80% CI") + autolayer(pred_lm$lower[, 1], lty = 3, series = "80% CI") + autolayer(pred_lm$upper[, 2], lty = 3, series = "95% CI") + autolayer(pred_lm$lower[, 2], lty = 3, series = "95% CI")
```

```{r}
#ARIMA with linear error ACF
acf(linear_arima_fit$residuals, main = "ACF of Residuals from sARIMA(1,1,2)(0,0,2([7]")
```

```{r}
#TSLM of differences
autoplot(pred_tslm$mean, series = "Predicted") + autolayer(sales_test_diff1, series = "Actuals") + xlab("Time") + ylab("Sales") + ggtitle("TSLM Predicted vs Actual Differences")
```

```{r}
#TSLM ACF
acf(tslm_fit$residuals, main = "ACF of Residuals from TSLM")
```

```{r}
# Convert test data to a dataframe
sales_test_df <- data.frame(Y=as.matrix(sales_test))

pred_lm_df <- data.frame(Y=as.matrix(pred_lm$mean))

lm_df <- cbind(sales_test_df, pred_lm_df)
colnames(lm_df) <- c("Y", "pred_lm_act")

tslm_df <- as.data.frame(cbind(sales_test_df, pred_tslm_act))
colnames(tslm_df) <- c("Y", "pred_tslm_act")

# RMSE
rmse_tslm <- rmse(tslm_df, "Y", "pred_tslm_act")
rmse_lm <- rmse(lm_df, "Y", "pred_lm_act")

cat("RMSE for TSLM model is ", rmse_tslm$.estimate)
cat("RMSE for linear model with ARIMA errors is ", rmse_lm$.estimate)
```

```{r}
# Test RMSEs for the linear models with ARIMA error selected by EACF
pred_eacf1 <- forecast(eacf1, h = 21, xreg = predictors_test)
pred_eacf1_df <- data.frame(Y=as.matrix(pred_eacf1$mean))
eacf1_df <- cbind(sales_test_df, pred_eacf1_df)
colnames(eacf1_df) <- c("Y", "pred_eacf1_act")
rmse_eacf1 <- rmse(eacf1_df, "Y", "pred_eacf1_act")

cat("RMSE for ARIMA with sARIMA(3,1,2)(0,0,7) model is ", rmse_eacf1$.estimate)
```

ADDING IN ALL PREDICTORS
```{r}
# Retrain the model using all predictors
predictors_all <- train[, c("Open", "Promo", "StateHoliday", "SchoolHoliday", "DayOfWeek")] #excluded: date, customers, year, week, month, day
linear_arima_fit_all <- auto.arima(sales, xreg = predictors_all, lambda = "auto", seasonal = TRUE, allowdrift = TRUE)
summary(linear_arima_fit_all)
checkresiduals(linear_arima_fit_all) #Ljung Box p-value is 2.2e-16

# Reforecast using updated model
predictors_test_all <- test[, c("Open", "Promo", "StateHoliday", "SchoolHoliday", "DayOfWeek")]
pred_lm_all <- forecast(linear_arima_fit_all, h = 21, xreg = predictors_test_all, level= c(80, 95))

# Reformat the predicted data
pred_lm_df_all <- data.frame(Y=as.matrix(pred_lm_all$mean))
lm_df_all <- cbind(sales_test_df, pred_lm_df_all)
colnames(lm_df_all) <- c("Y", "pred_lm_act_all")

# RMSE
rmse_lm_all <- rmse(lm_df_all, "Y", "pred_lm_act_all")
cat("RMSE for ARIMA with linear errors model is ", rmse_lm_all$.estimate)
```

```{r}
#ARIMA with linear error actuals + forecast
pred_eacf1 <- forecast(eacf1, h = 21, xreg = predictors_test, level= c(80, 95))

autoplot(pred_eacf1$mean, series = "Predicted", ylab = "Sales") + autolayer(sales_test, series = "Actuals") + autolayer(tail(sales, 13), series = "Last quarter of training data") + xlab("Time") +  ggtitle("sARIMA(3,1,2)(0,0,2)[7] Predicted vs Actual") + autolayer(pred_eacf1$upper[, 1], lty = 3, series = "80% CI") + autolayer(pred_eacf1$lower[, 1], lty = 3, series = "80% CI") + autolayer(pred_eacf1$upper[, 2], lty = 3, series = "95% CI") + autolayer(pred_eacf1$lower[, 2], lty = 3, series = "95% CI")
```

```{r}
#EACF ARIMA with linear error ACF
acf(eacf1$residuals, main = "ACF of Residuals from sARIMA(3,1,2)(0,0,2)[7]")
```

```{r}
# Retrain using all predictors
eacf1_all <- Arima(sales, xreg = predictors_all, order = c(3, 1, 2), seasonal=list(order=c(0,0,2), period = 7), lambda = "auto")
checkresiduals(eacf1_all)

# Predict
pred_eacf1_all <- forecast(eacf1_all, h = 21, xreg = predictors_test_all, level= c(80, 95))

# Reformat the predicted data
pred_eacf1_df_all <- data.frame(Y=as.matrix(pred_eacf1_all$mean))
eacf_df_all <- cbind(sales_test_df, pred_eacf1_df_all)
colnames(eacf_df_all) <- c("Y", "pred_lm_act_all")

# RMSE
rmse_eacf1_all <- rmse(eacf_df_all, "Y", "pred_lm_act_all")
cat("RMSE for ARIMA with linear errors model is ", rmse_eacf1_all$.estimate)
```